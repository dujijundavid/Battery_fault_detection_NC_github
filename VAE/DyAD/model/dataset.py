import os
import torch
import numpy as np
from glob import glob
from tqdm import tqdm
from torch.utils.data import Dataset as TorchDataset
def _safe_load(fp):
    try:
        return torch.load(fp, map_location="cpu")
    except Exception:
        return None
class Dataset(TorchDataset):
    '''
    按“原来的方式”选车，只是改为懒加载：不把数据常驻内存
    '''
    def __init__(self, data_path,
                 all_car_dict_path='../five_fold_utils/all_car_dict.npz.npy',
                 ind_ood_car_dict_path='../five_fold_utils/ind_odd_dict1.npz.npy',
                 train=False, fold_num=0):
        ind_ood_car_dict = np.load(ind_ood_car_dict_path, allow_pickle=True).item()
        self.ind_car_num_list = ind_ood_car_dict['ind_sorted']
        self.ood_car_num_list = ind_ood_car_dict['ood_sorted']
        self.all_car_dict = np.load(all_car_dict_path, allow_pickle=True).item()
        # ====== 保持你的原始“数据输入方式/选车逻辑” ======
        # 你当前文件里是：train=False 用 ['0_0001']；train=True 用 []。按你当前版本来：
        if train:
            car_number = ['0_0118','0_2381','0_0573','0_0852','0_2392','0_0610','0_0214','0_2469','0_0520','0_0714','0_2824','0_2449','0_0178','0_0100','0_2693','0_2119','0_0231','0_2005','0_0793','0_2767','0_2583','0_2137','0_0893','0_0495','0_0880','0_2567','0_2624','0_0861','0_2004','0_2833','0_0867','0_0742','0_2587','0_0845','0_2427','0_2344','0_2084','0_2766','0_2305','0_0795','0_2514','0_2716','0_0663','0_2435','0_0882','0_0824','0_0235','0_0152','0_2008','0_2259','0_2598','0_0611','0_2493','0_2612','0_2169','0_0840','0_0037','0_2274','0_0293','0_2327','0_2757','0_2177','0_2018','0_2608','0_0926','0_2286','0_2731','0_2422','0_0578','0_0594','0_0630','0_0471','0_0025','0_2062','0_2458','0_0646','0_2758','0_2421','0_2554','0_2499','0_2510','0_2204','0_0878','0_2669','0_0786','0_2615','0_0330','0_2770','0_2548','0_0200','0_0161','0_2654','0_0217','0_0075','0_2355','0_2186','0_0916','0_2330','0_0162','0_0860','0_2307','0_2857','0_0106','0_0164','0_2205','0_0227','0_0869','0_0607','0_2102','0_2721','0_0394','0_0782','0_0704','0_2740','0_2418','0_0213','0_2771','0_0461','0_0020','0_0185','0_2397','0_0180','0_2829','0_2475','0_0655','0_2759','0_0665','0_0908','0_2252','0_2438','0_2689','0_0712','0_0431','0_2684','0_0398','0_0169','0_0087','0_0672','0_0753','0_2090','0_0295','0_2636','0_2596','0_2504','0_2795','0_0450','0_0281','0_2620','0_2139','0_0775','0_0443','0_2674','0_0748','0_2140','0_2613','0_0577','0_0806','0_2599','0_0682','0_2527','0_0266','0_2215','0_0776','0_0510','0_0453','0_2451','0_0706','0_0976','0_2228','0_0666','0_2043','0_2447','0_0196','0_2163','0_2588','0_2188','0_0282','0_0674','0_2677','0_2203','0_2315','0_0928','0_0422','0_0705','0_2300','0_0336','0_0045','0_2614','0_2448','0_2690','0_0956','0_0736','0_2282','0_2748','0_0911','0_0585','0_2173','0_0836','0_2682','0_0935','0_2640','0_0019','0_0897','0_0961','0_0079','0_0807','0_2432','0_2201','0_2237','0_2155','0_2178','0_2568','0_0290','0_0559','0_2436','0_2580','0_2713','0_0521','0_0036','0_2743','0_0187','0_2473','0_0639','0_0151','0_0747','0_0759','0_2181','0_0913','0_2024','0_2576','0_0694','0_2114','0_2732','0_2390','0_0602','0_0418','0_2394','0_2828','0_2646','0_2573','0_0193','0_2702','0_0183','0_2768','0_0730','0_2185','0_0256','0_0527','0_0551','0_0859','0_0608','0_0263','0_2664','0_0117','0_0542','0_2452','0_0717','0_0511','0_0029','0_2168','0_2675','0_0616','0_0728','0_2072','0_0090','0_0206','0_0424','0_0787','0_0635','0_0851','0_2433','0_0693','0_0835','0_2520','0_2688','0_0758','0_0115','0_0392','0_0677','0_2029','0_2118','0_2184','0_0991','0_2260','0_0550','0_2512','0_2796','0_0223','0_0241','0_0046','0_2166','0_0448','0_0904','0_2850','0_0170','0_2582','0_0245','0_2202','0_0942','0_0179','0_2797','0_2694','0_2345','0_2641','0_2069','0_0598','0_0201','0_2815','0_2661','0_2507','0_2604','0_2663','0_2464','0_0007','0_2125','0_0671','0_2434','0_0497','0_0163','0_2012','0_0466','0_2312','0_0306','0_0032','0_2031','0_2450','0_2474','0_2388','0_2278','0_2441','0_2240','0_2154','0_0024','0_2309','0_0255','0_2147','0_0999','0_0526','0_0951','0_0631','0_2025','0_0978','0_0921','0_0379','0_0276','0_2414','0_0969','0_0713','0_2813','0_0962','0_2645','0_0554','0_0272','0_0818','0_0171','0_2541','0_2011','0_2230','0_2799','0_2417','0_0505','0_2224','0_2206','0_2120','0_2635','0_0192','0_0750','0_0156','0_2164','0_0307','0_2036','0_0668','0_0361','0_0108','0_2244','0_2811','0_2157','0_0881','0_2399','0_2650','0_0802','0_0680','0_2667','0_0638','0_0623','0_0364','0_2128','0_0823','0_0644','0_2424','0_2100','0_2560','0_0817','0_0230','0_0451','0_2324','0_2656','0_2412','0_2391','0_2089','0_2852','0_2718','0_2389','0_0596','0_2032','0_0996','0_2594','0_0535','0_0253','0_2617','0_0968','0_0890','0_0043','0_0678','0_0097','0_2429','0_0640','0_2340','0_2727','0_0857','0_2454','0_2800','0_0941','0_0274','0_2672','0_2151','0_0854','0_2419','0_0084','0_2333','0_2488','0_0726','0_2273','0_0841','0_0900','0_0810','0_0135','0_0767','0_2747','0_2628','0_0822','0_0567','0_2250','0_0027','0_0105','0_0697','0_0853','0_0150','0_2023','0_0873','0_0341','0_0583','0_0648','0_2174','0_2373','0_2745','0_2398','0_2150','0_2658','0_0501','0_0874','0_0337','0_2034','0_2648','0_2480','0_0548','0_2048','0_0225','0_2746','0_2319','0_2637','0_0233','0_0308','0_0729','0_0593','0_2715','0_0286','0_2443','0_0439','0_0741','0_2270','0_0929','0_0325','0_2176','0_0715','0_0333','0_0373','0_0465','0_0733','0_2853','0_2460','0_2516','0_2711','0_2622','0_0938','0_0353','0_0173','0_2211','0_0442','0_0582']
        else:
            car_number = ['1_0001'] # ← 按你现有代码
        # 如果你要换回那一长串车号，也直接把 car_number 改回原来的大列表即可
        self.data_path = data_path
        # ====== 改这里：不加载内容，仅收集路径 ======
        file_paths = []
        for num in car_number:
            file_paths.extend(self.all_car_dict.get(num, []))
        print(f"加载 {len(file_paths)} 个数据文件（惰性读取，不驻留内存）...")
        # 做个轻量过滤：只保留存在且非空的文件
        self.file_paths = []
        self.bad_files = []
        for fp in tqdm(file_paths, desc="索引构建", ncols=100):
            try:
                if os.path.isfile(fp) and os.path.getsize(fp) > 0:
                    self.file_paths.append(fp)
                else:
                    self.bad_files.append(fp)
            except Exception:
                self.bad_files.append(fp)
        if self.bad_files:
            print(f"[WARN] 预先剔除坏/空文件: {len(self.bad_files)}")
        # 可选：随机数生成器，用于坏样本重试
        self._rng = np.random.default_rng(2025)
        self._max_retry = 20
    def __len__(self):
        return len(self.file_paths)
    def __getitem__(self, idx):
        # 惰性读取：需要时再 load
        # 对偶发坏样本做容错，最多重试几次换一个样本
        tries = 0
        while tries < self._max_retry:
            fp = self.file_paths[idx]
            obj = _safe_load(fp)
            if obj is not None:
                return obj # 维持原结构：(win, meta)
            tries += 1
            idx = int(self._rng.integers(0, len(self.file_paths)))
        # 实在不行抛错，让 DataLoader 重新取
        raise IndexError("Too many bad samples encountered.")