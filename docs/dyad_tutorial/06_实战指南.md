# 第5章：实战指南

> **章节定位**: DyAD 模型的运行、调试和实战技巧
>
> **预计学习时间**: 1-2 小时

---

## 目录

- [5.1 环境配置](#51-环境配置)
- [5.2 数据准备](#52-数据准备)
- [5.3 训练模型](#53-训练模型)
- [5.4 运行推理](#54-运行推理)
- [5.5 常见问题排查](#55-常见问题排查)

---

## 5.1 环境配置

### 依赖安装

```bash
# 创建虚拟环境（推荐）
python -m venv venv_dyad
source venv_dyad/bin/activate

# 安装 PyTorch
pip install torch==1.13.0 torchvision==0.14.0

# 安装其他依赖
pip install numpy pandas matplotlib seaborn jupyter
```

### 目录结构

```
Battery_fault_detection_NC_github/
├── DyAD/                      # 模型代码
│   ├── model/                 # 核心模型
│   │   ├── dynamic_vae.py    # DynamicVAE 类
│   │   ├── tasks.py          # 任务定义
│   │   └── dataset.py        # 数据加载
│   ├── train.py              # 训练脚本
│   ├── evaluate.py           # 评估脚本
│   └── model_params_*.json  # 超参数配置
├── data/                      # 数据目录
└── docs/dyad_tutorial/       # 教程（本文件）
```

---

## 5.2 数据准备

### 数据格式要求

```python
# DyAD 期望的输入数据格式
{
    'soc': array,           # 荷电状态 [0-1]
    'current': array,        # 电流 (A)
    'max_temp': array,       # 最高温度
    'max_single_volt': array, # 最高单体电压
    'min_single_volt': array, # 最低单体电压
    'volt': array,           # 总电压
    'mileage': array,        # 车辆里程（标签）
    'label': array           # 0=正常, 1=故障
}
```

### 数据预处理

```python
from utils import PreprocessNormalizer

# 加载预处理参数
normalizer = PreprocessNormalizer(
    mean_path='path/to/mean.npy',
    std_path='path/to/std.npy'
)

# 归一化数据
norm_data = normalizer.norm_func(raw_data)
```

---

## 5.3 训练模型

### 快速开始

```bash
# 进入 DyAD 目录
cd DyAD/

# 运行训练
python train.py \
    --params model_params_battery_brand1.json \
    --gpu 0 \
    --fold 0
```

### 训练命令参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--params` | 配置文件路径 | `model_params_battery_brand1.json` |
| `--gpu` | GPU 设备 ID | `0` (第一块 GPU) |
| `--fold` | 当前折数 | `0-4` (五折之一) |
| `--checkpoint` | 检查点路径 | `checkpoints/model.ckpt` |

### 监控训练进度

```bash
# 使用 TensorBoard
tensorboard --logdir runs/

# 或者查看日志文件
tail -f runs/train_log.txt
```

---

## 5.4 运行推理

### 单样本推理

```python
from model.dynamic_vae import DynamicVAE
import torch

# 加载模型
model = DynamicVAE(**params)
model.load_state_dict('path/to/checkpoint.pth')
model.eval()  # 设置为推理模式

# 推理
with torch.no_grad():
    log_p, mean, log_v, z, mean_pred = model(
        soc, current, features, seq_lengths
    )

# 计算重构误差
rec_error = torch.sum(torch.abs(log_p - targets))
print(f"重构误差: {rec_error.item()}")
```

### 批量评估

```python
# 运行评估脚本
python evaluate.py \
    --params model_params_battery_brand1.json \
    --gpu 0 \
    --model_path checkpoints/best_model.pth \
    --output results/
```

---

## 5.5 常见问题排查

### 训练相关

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| **Loss = NaN** | 学习率过大或梯度爆炸 | 降低学习率，添加梯度裁剪 |
| **KL = 0** | 后验塌缩 | 增加 KL 退火步数 |
| **重构不改善** | 损失权重不平衡 | 调整 nll_weight |
| **内存溢出** | batch_size 太大 | 减小 batch_size |

### 推理相关

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| **所有样本误差相同** | model.eval() 未设置 | 确保推理模式 |
| **误差异常大** | 数据归一化不匹配 | 使用与训练相同的归一化参数 |
| **维度错误** | 序列长度不正确 | 检查 seq_lengths 数组 |

### 调试技巧

```python
# 启用异常检测
torch.autograd.set_detect_anomaly(True)

# 检查 NaN
if torch.isnan(torch.any(output)):
    print("Warning: NaN detected!")

# 梯度检查
for name, param in model.named_parameters():
    if param.grad is not None:
        print(f"{name}: grad_norm={param.grad.norm()}")
```

---

## 本章小结

学习完本章后，您应该能够：

- [ ] 配置 DyAD 的开发环境
- [ ] 准备和预处理数据
- [ ] 运行模型训练
- [ ] 执行推理和评估
- [ ] 排查常见问题

### 快速参考卡片

#### 训练命令速查

```bash
# 标准训练
python train.py --params model_params_xxx.json --gpu 0 --fold 0

# 五折训练
for fold in 0 1 2 3 4; do
    python train.py --params model_params_xxx.json --gpu 0 --fold $fold
done
```

#### 推理命令速查

```bash
# 评估
python evaluate.py --params model_params_xxx.json --gpu 0 --model_path checkpoints/best_model.pth

# 提取特征
python extract.py --gpu 0 --model_path checkpoints/best_model.pth --data_path data/new_data.csv
```

---

**回到教程首页**: [README.md](./README.md)

**章节版本**: v1.0
**最后更新**: 2025-02-12
